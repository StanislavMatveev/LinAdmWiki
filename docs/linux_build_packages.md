# Сборка пакетов из исходного кода

*[[linux|<- Назад]]*

*[[index|<- На главную]]*
***
## Сборка программы

Для *сборки* программ в Linux используется (в основном) программа `make`, которая запускает инструкцию из `Makefile`. Но поскольку дистрибутивов Linux много, и они все разные, то для того чтобы собрать программу, нужно прописать пути до библиотек и заголовочных файлов, этим занимаются *конфигураторы*. Если конифгуратор отсутствует, его необходимо *собрать*.

`make` - утилита, используемая для *автоматизации* сборки программного обеспечения. `make` собирает только то, что *нужно* собрать, т.е. она старается обеспечить актуальность целевых файлов. `make` гарантирует, что целевые файлы будут более *новыми*, чем их зависимости.

`Makefile` - это файл, в котором описаны *правила* сборки проекта. Он содержит информацию о том, какие файлы нужно компилировать, какие команды для этого использовать и какие зависимости существуют между файлами.

**Подготовка**

- *Устанавливаем* необходимые для сборки пакеты:

```bash
apt install build-essential autoconf automake
```

> Перед началом сборки программы, нужно *внимательно* ознакомиться с приложенной к ней *документацией* и установить все необходимые зависимости. Это избавит от ошибок и лишней траты времени в будущем. *Это действие является одним из самых важных шагов для успеха сборки!*

**Сборка конфигуратора**

- Чтобы собрать что-то из исходников, нужно сначала *собрать* конфигуратор (если его нету). Как собрать конфигуратор, описано в файле `configure.in`. Для сборки конфигуратора необходимо выполнить:

```bash
./bootstrap
---or---
./autogen.sh
```

- Если таких скриптов в архиве *не оказалось*, то можно выполнить последовательно следующие команды:

```bash
aclocal
autoheader
automake --gnu --add-missing --copy --foreign
autoconf -f -Wall
```

> Все эти команды используют файл `configure.in`. После их выполнения создастся файл `configure`.

**Сборка программы**

- *Запускаем* конфигуратор для проверки наличия всех зависимостей, а также установки дополнительных опций сборки и просмотра результата установки:

```bash
./configure
# Конфигурация с указанием директории для установки /usr
# (по умолчанию /usr/local)
./configure --prefix=/usr
```

> В процессе сборки могут возникать *ошибки* связанные с отсутствием необходимых пакетов. Необходимо установить эти пакеты и запустить кофигуратор по новой. Если будут попадаться пакеты с приставкой `dev`, то их и тоже нужно установить.

- *Запускаем* процесс сборки самой программы:

```bash
make
```

- Выполняем тесты, если есть (опционально):

```bash
make check
```

**Установка и очистка (опционально)**

- Устанавливаем (разносим файлы по необходимым каталогам) собранную программу:

```bash
# Выведет какие команды будут использованны, без изменений
make -n install
# Если на предыдущем шаге ничего не смутило, идем дальше
make install
```

- Очищаем временные файлы, созданные во время сборки:

```bash
make clean
```

> Данный способ является не самым лучшим решение, т.к. после такой установки нормально *удалить* или *обновить* пакет, скорее всего, не получится.

***
## Сборка пакета

После сборки программы из исходного кода, логичным решением будет *упаковать* ее в удобный для распространения формат, например пакет для пакетного менеджера.

### Сборка при помощи checkinstall

`checkinstall` - утилита, которая позволяет создавать *пакеты* для пакетных менеджеров (прим. DEB или RPM) при установке программного обеспечения из *исходников*. Она отслеживает установку и создает пакет, который можно легко установить, удалить или обновить с помощью стандартного пакетного менеджера.

*Установка:*

```bash
apt install checkinstall
```

*Использование:*

```bash
# Установка и создание пакета
checkinstall
# Создание пакета без установки
checkinstall --install=no
```

> При выполнении этой команды будет предложено ввести *информацию о пакете* (имя, версия, описание, зависимости и т.д.), также можно указать какой тип пакета будет создан.


> При установке, версия пакета *должна начинаться* с цифры, в противном случае это вызовет ошибку!

### Сборка при помощи dpkg

`dpkg` - низкоуровневая система *управления* пакетами для операционных систем на базе Debian. Она используется для установки, удаления и управления программным обеспечением, упакованным в формате `.deb`.

> Все ниже приведенные действия идут *после* этапа сборки программы - `make`.

> Здесь рассмотрена лишь малая и самая *необходимая* часть настроек. Больше *информации* можно найти либо в документации, либо в [статье](https://habr.com/ru/articles/78094/) на Хабре.

**Сборка пакета**

- *Устанавливаем* собранную программу во временную директорию:

```bash
# Чтобы не было проблем с правами можно использовать fakeroot-окружение
fakeroot
# Непосредственно установка
make install DESTDIR=/path/to/temp/dir
```

> После данного действия, во временной папке появится вся *структура* расположения файлов пакета. Соответственно на данном этапе можно *добавить* свой конфигурационные файлы или например файлы для `systemd`.

- Создаем каталог для информации, которая управляет генерацией пакета:

```bash
mkdir /path/to/temp/dir/DEBIAN
```

> Название каталога `DEBIAN`, *обязательно* должно быть в верхнем регистре!

- Создаем основной информационный файл пакета:

```bash
vim /path/to/temp/dir/DEBIAN/control
```

*control*
```
Package: имя_пакета
Version: 1.2.3 (должна начинаться с числового символа)
Architecture: amd64/i386/armel/all
Section: admin
Maintainer: имя_или_почта_собирающего
Depends: список, необходимых, пакетов, через, запятую
Priority: optional
Description: описание
```

- Создаем файл, в котором перечисляем все конфигурационные файлы. Данный файл позволит избежать перезаписи уже существующих и отредактированных файлов конфигурации (опционально):

```bash
vim /path/to/temp/dir/DEBIAN/conffiles
```

*conffiles*
```
/etc/app/app.conf
/etc/app/templates/template1
/etc/app/templates/template2
```

- Создаем скрипты `preinst/postinst/prerm/postrm` (опционально):

```bash
vim /path/to/temp/dir/DEBIAN/preinst
```

| Скрипт          | Назначение                                                                                                                                      |
| --------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| DEBIAN/preinst  | Выполняется *перед установкой* пакета: он может подготовить что-либо для успешной установки.                                                    |
| DEBIAN/postinst | Выполняется сразу *после установки* пакета: он настраивает установленный пакет так, чтоб он был готов к работе.                                 |
| DEBIAN/prerm    | Выполняется непосредственно *перед удалением* пакета: обычно этот скрипт очищает установочные пути пакета так, чтоб ничего лишнего не осталось. |
| DEBIAN/postrm   | Выполняется сразу *после удаления* пакета: удаляет остатки.                                                                                     |

> Ошибки возникающие в этих скриптах никак *не логируются*. Логирование необходимо делать *вручную*! 

*preinst*
```bash
#!/bin/bash

rm -r /etc/app
```

- Собираем пакет:

```bash
dpkg -b /path/to/temp/dir
```

### Установка собранного пакета

Собранный пакет можно установить несколькими способами.

- С помощью `dpkg`:

```bash
# Устанавливаем локальный пакет
dpkg -i pack_name.deb
# Если у пакета были зависимости и при установке возникли ошибки
apt install -f
```

- С помощью `apt`:

```bash
apt install ./pack_name.deb
```

***