# nginx

*[[apps|<- Назад]]*
*[[index|<- На главную]]*
***
## Основы nginx

[Документация.](https://nginx.org/ru/docs/)

`nginx(engine x)` - это HTTP-сервер и обратный прокси-сервер, почтовый прокси-сервер, а также TCP/UDP прокси-сервер общего назначения.

У nginx есть один *главный* и несколько *рабочих* процессов. Основная задача главного процесса - чтение и проверка конфигурации и управление рабочими процессами. Рабочие процессы выполняют фактическую *обработку запросов*.

*Установка* описана на [cайте](https://nginx.org/ru/linux_packages.html).

*Основной конфигурационный файл nginx.conf может хранится в следующих директориях:*
- `/etc/nginx/`
- `/usr/local/nginx/conf/`
- `/usr/local/etc/nginx/`

*Дополнительные конфигурации создаем в:*
- `/etc/nginx/sites-available/` - конфиги сайтов
- `/etc/nginx/sites-enabled/` - ссылки на конфиги из папки выше (ссылку на конфиг можно создать с помощью `ln -s`)
- `/etc/nginx/conf.d/` - общие конфиги

> Если при установке nginx нету папок `sites-available` и `sites-enabled` их надо *создать*. А после этого *прописать* `sites-enabled` в главный файл `nginx.conf`.

*Логи хранятся в следующих директориях:*
- `/usr/local/nginx/logs/`
- `/var/log/nginx/`

[[nginx#nginx|^ В начало]]
***
##  Команды управления

> Команды должны выполняться под тем же *пользователем*, под которым был *запущен* nginx.

*Основные команды:*
- Протестировать конфиг
```bash
nginx -t
```
- Быстрое завершение
```bash
nginx -s stop
```
- Плавное завершение (с *ожиданием окончания* обслуживания текущих запросов рабочими процессами)
```bash
nginx -s quit
```
- Перезагрузка конфигурационного файла (изменения, сделанные в конфиге, не будут применены, пока не будет отправлена команда перезагрузить конфигурацию или пока nginx не будет перезапущен)
```bash
nginx -s reload
```

> Получив сигнал, главный процесс проверяет *правильность синтаксиса* нового конфигурационного файла и пытается применить конфигурацию, содержащуюся в нём. Если это ему удаётся, главный процесс запускает новые рабочие процессы и отправляет сообщения старым рабочим процессам с требованием завершиться. В противном случае, главный процесс *откатывает* изменения и продолжает работать со старой конфигурацией. Старые рабочие процессы, получив команду завершиться, прекращают принимать новые запросы и продолжают обслуживать текущие запросы до тех пор, пока все такие запросы не будут обслужены. После этого старые рабочие процессы завершаются.

- Переоткрытие лог-файлов
```bash
nginx -s reopen
```

[[nginx#nginx|^ В начало]]
***
## Структура конфигурационного файла

nginx состоит из *модулей*, которые настраиваются *директивами*, указанными в конфигурационном файле. Директивы делятся на *простые и блочные*. Простая директива состоит из *имени и параметров*, разделённых пробелами, и оканчивается точкой с запятой (`;`). Блочная директива устроена так же, как и простая директива, но вместо точки с запятой после имени и параметров следует набор дополнительных инструкций, помещённых внутри фигурных скобок (`{` и `}`). Если у блочной директивы внутри фигурных скобок можно задавать другие директивы, то она называется *контекстом*.

### Раздача статического содержимого

Одна из важных задач конфигурации nginx - *раздача* файлов, таких как изображения или статические HTML-страницы.

*Пример конфига для раздачи разного статического содержимого из папок `/data/www` и `/data/images` в зависимости от запроса:*
```nginx
http {
	server {
		location / {
			root /data/www;    # Задаем корневой каталог для запросов
		}

		location /images/ {
			root /data;
		}
	}
}
```

> Конфигурационный файл может содержать *несколько* блоков `server`, различаемых по портам, на который они слушают, и по имени сервера.
> 

*Пример конфига для раздачи статического содержимого с использованием именованного сервера:*
```nginx
http {
	server {
		listen 80;    # Слушать порт 80
		server_name name.example;    # Задаем имя сервера
		root /var/www/html;
		index index.html index.htm;   # Определяем файлы индекса

		location / {
			try_files $uri $uri/ =404;   # Проверяем существование файлов
		}
	}
}
```

> Директива `root` помещенная в контекст `server`, будет использована, когда директива `location`, выбранная для выполнения запроса, не содержит *собственной* директивы `root`.

> Директива `try_files` проверяет *существование* файлов в заданном *порядке* и использует для обработки запроса *первый найденный* файл. С помощью слэша проверяем существование каталога. Если ни один файл не найден, то делается внутреннее перенаправление на `uri`, заданный *последним параметром*. В случае выше указан код ошибки, которая будет выведена.

### Настройка простого прокси-сервера

Одним из частых применений nginx является использование его в качестве прокси-сервера, то есть сервера, который *принимает* запросы, *перенаправляет* их на проксируемые сервера, *получает* ответы от них и *отправляет* их клиенту.

*Пример конфига для создания прокси-сервера:*
```nginx
http {
	server {
		listen 8080;    # Слушать порт 8080
		root /data/www;

		location / {
		}
	}

	server {
		location / {
			proxy_pass http://localhost:8080;
		}
	}
}
```

### Балансировка нагрузки

Nginx можно использовать в качестве очень эффективного *балансировщика нагрузки* HTTP для *распределения* трафика между несколькими серверами приложений и повышения производительности, масштабируемости и надежности веб-приложений.

*Пример простого конфига для создания балансировщика нагрузки:*
```nginx
http {
	upstream example_app {
		server srv1.example.com;
		server srv2.example.com;
		server srv3.example.com;
	}

	server {
		listen 80 default_server;
		listen [::]:80 default_server;    # Для IPv6 адресов

		server_name _;    # Для запросов без имени,
						  # работает вместе с default_server

		location / {
			proxy_pass http://example_app;
		}
	}
}
```

> Если в директиве `listen` указать параметр `default_server`, то этот сервер будет использоваться *по умолчанию*.

> При использовании nginx в качестве *балансировщика* нагрузки и использовании директивы `upstream`, работает следующий *принцип*: если при попытке работы с сервером происходит *ошибка*, то запрос передается *следующему* серверу, и так далее до тех пор, пока не будут *опробованы* все работающие серверы. Если не удастся получить успешный ответ *ни от одного* из серверов, то клиенту будет возвращен результат работы с *последним* сервером.

[[nginx#nginx|^ В начало]]
***