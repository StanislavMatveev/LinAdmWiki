# SSH

*[[apps|<- Назад]]*

*[[index|<- На главную]]*
***
### Основы SSH

`OpenSSH (Open Secure Shell)` - *набор программ*, предоставляющих *шифрование* сеансов связи в компьютерных сетях с использованием протокола *SSH*. OpenSSH разработан в рамках проекта OpenBSD, как открытая *альтернатива* проприетарному Secure Shell компании SSH Communications Security.

`SSH (Secure Shell)` - *сетевой протокол* прикладного уровня, позволяющий производить удаленное *управление* операционной системой и *туннелирование* TCP-соединений (например, для передачи файлов). Данный протокол *шифрует* всю передаваемую информацию по сети.

Чтобы *установить* соединение, необходимо два компонента: *SSH-сервер и SSH-клиент*. Сервер *прослушивает* определенный порт (по умолчанию это 22 порт) и при успешной аутентификации дает *доступ* пользователю. Все команды, которые используются на SSH-клиенте, отправляются через *защищенный* канал связи на SSH-сервер, на котором они выполняются и отправляют результат работы обратно клиенту.

*Установка SSH-сервера:*

```bash
# Устанавливаем необходимый пакет
apt install openssh-server
# Запускаем службу
systemctl enable sshd
```

*Установка SSH-клиента:*

```bash
# Устанавливает необходимы пакет
apt install openssh-client
# Или
apt install ssh
```

*Установка соединения с сервером:*

```bash
ssh <user_name>@<server_address>
# Или
ssh <user_name>@<server_address> -p <server_port>
```

*Выполнение команды на сервере:*

```bash
ssh <user_name>@<server_address> ls -la
```

> В ssh можно создавать *алиасы*. Для этого в файл `~/.ssh/config`, нужно добавить следующие строки:
> ```
> Host <alias_name>
> 	HostName <server_address>
> 	User <user_name>
> 	Port <server_port>
> ```
> Все доступные *опции* можно увидеть в `man ssh_config`.

***
### Доступ к серверу по SSH-ключам

Стандартное подключение к SSH-серверу осуществляется по *паролю*, но желательно настроить подключение через *SSH-ключи*, такой вариант удобнее и *безопаснее*.

*Настройка доступа по ключам:*

- *Генерируем* ключи если их еще нету (в процессе генерации, будет предложено задать парольную фразу, рекомендуется не оставлять ее пустой):

```bash
# ED25519-key
ssh-keygen -t ed25519
# RSA-key
ssh-keygen -t rsa -b 4096
```

> Ключи сохраняются в папку `~/.ssh/`:
> - `id_rsa` - *закрытый (приватный)* ключ;
> - `id_rsa.pub` - *открытый (публичный)* ключ.
> 
> Названия ключей могут отличаться.

- *Копируем* публичный ключ на сервер:

```bash
ssh-copy-id <user_name>@<server_address>
# Или если SSH работает на нестандартном порту (кавычки обязательны)
ssh-copy-id '-p <server_port> <user_name>@<server_address>'
```

* После запроса *вводим* пароль и все готово. Теперь можно входить на сервер без ввода пароля.

> *Вместо* копирования публичного ключа с помощью команды `ssh-copy-id`, можно *прописать* этот ключ в файл `~/.ssh/authorized_keys` на *SSH-cервере*.

***
### Копирование файлов через SCP

`SCP (Secure Copy)` - утилита и протокол *копирования* файлов между компьютерами, использующий в качестве транспорта шифрованный *SSH*.

*Основные применения:*

- Копирование локального файла на SSH-сервер:

```bash
scp <path_to_file> <user_name>@<server_address>:<path_for_save>
```

- Копирование локальной директории на SSH-сервер:

```bash
scp -r <path_to_dir> <user_name>@<server_address>:<path_for_save>
```

- Копирование файла с SSH-сервера в текущую директорию:

```bash
scp <user_name>@<server_address>:<path_to_file> ./
```

- Копирование файла с SSH-сервера в указанную директорию:

```bash
scp <user_name>@<server_address>:<path_to_file> <path_for_save>
```

***
### Обеспечение безопасности при подключении через SSH

Более *специфичные* практики можно посмотреть на [сайте](https://www.cyberciti.biz/tips/linux-unix-bsd-openssh-server-best-practices.html).

Настройки *подключения* SSH хранятся в файле `/etc/ssh/sshd_config`.

*Основные настройки безопасности:*

- Изменение стандартного *порта*:

```
Port 479
```

- Слушать только определенные *IP-адреса*:

```
ListenAddress 192.168.1.10
```

- Отключаем вход для *root*-пользователя (прежде чем отключить рута необходимо быть уверенным, что оставшиеся пользователи имеют рут доступ):

```
PermitRootLogin no
```

- Устанавливаем *лимит* на попытки аутентификации (после указанного количества запросов аутентификации пользователь будет отключен от SSH-сервера):

```
MaxAuthTries 3
```

- Устанавливаем *максимальное* количество открытых оболочек, аутентификаций или подсистем (прим. `sftp`) для *одного пользователя* через *одно соединение* (используется в основном при мультиплексировании):

```
MaxSessions 5
```

- Включаем аутентификацию по *ключу*:

```
PubkeyAuthentication yes
```

- Отключаем аутентификацию на основе доверия между хостами:

```
HostbasedAuthentication no
```

- Отключаем использование *файла* `.rhosts` (он содержит информацию о доверенных хостах и пользователях для аутентификации, что можно использовать для подмены):

```
IgnoreRhosts yes
```

- Отключаем аутентификацию по *паролю*:

```
PasswordAuthentication no
```

- Отклоняем запросы на подключение *профилей без паролей*:

```
PermitEmptyPasswords no
```

- ??? Отключаем использование модуля *PAM* (Pluggable Authentication Modules):

```
UsePAM no
```

- Отключаем переадресацию *X11* (возможность использования графического интерфейса):

```
X11Forwarding no
```

- Устанавливаем значение *тайм-аута простоя* (после достижения указанного времени простоя, пользователь будет отключен от SSH-сервера):

```
ClientAliveInterval 300
ClientAliveCountMax 1
```

- Указываем максимальное количество одновременных *не аутентифицированных* подключений к SSH демону (<`максимальное_количество_подключений`>:<`вероятность_отказа_после_достижения_макс_кол_подкл`>:<`количество_подключений_при_котором_отказ_равен_100`>). Процент отказа *увеличивается линейно*, по мере возрастание подключений выше максимально указанного значения, пока не достигнет 100%.

```
MaxStartups 10:30:50
```

- *Разрешаем* вход только определенным пользователям:

```
AllowUsers <user_name_1> <user_name_2> ...
```

- *Запрещаем* вход определенным пользователям:

```
DenyUsers <user_name_1> <user_name_2> ...
```

> После редактирования файла, необходимо *сохранить* изменения и *перезагрузить* сервис SSH командой: `service sshd restart`.
> Так же стоит обратить внимание на параметр `Include`, если он присутствует, то конфиги, которые он подгрузит, имеют *больший приоритет* и соответственно примененные изменения могут не сработать. *Рекомендуется* закомментировать данный параметр.

***