# LXC

*[[apps|<- Назад]]*
*[[index|<- На главную]]*
***
## Основы LXC

`LXC (Linux Containers)` - подсистема *контейнеризации*, позволяющая запускать несколько изолированных экземпляров ОС Linux на одном узле. LXC создает виртуальное окружение с собственным пространством процессов и сетевым стеком (*userspace*), при этом все экземпляры LXC используют один экземпляр ядра операционной системы (*kernelspace*). 

> LXC и Docker очень *похожи* друг на друга, с той лишь разницей, что Docker контейнер используется для упаковки *одного* процесса или службы, а LXС контейнер включает в себя *все службы* необходимые для его функционирования.
> 
> Docker *использовал* LXC до версии 1.0 для создания изоляции от хост-системы. Позже Docker разработал собственную *замену* LXC под названием libcontainer. Вот почему Docker и LXC имеют так много *общего*.

LXC использует технологии [[cgroups_namespaces#Контрольные группы|контрольных групп]] и [[cgroups_namespaces#Пространство имен|пространств имен]], входящие в ядро Linux начиная с версии 2.6.29.

**Установка:**
```bash
sudo apt install lxc lxc-templates
```

**LXC хранит свои данные в следующих папках:**
- `/var/lib/lxc/` - контейнеры, их настройки, ФС, снапшоты и так далее;
- `/etc/lxc/` - прочие настройки;
- `/usr/share/lxc/templates/` - доступные шаблоны;
- `/var/cache/lxc/` - скачанные шаблонов.

**[Сайт](https://images.linuxcontainers.org/) с образами.** 

[[lxc#LXC|^ В начало]]
***
## Управление контейнерами

**Базовые команды:**
- Проверка имеет ли Linux необходимую конфигурацию ядра:
```bash
sudo lxc-checkconfig
```
- Создание контейнера (прим. Ubuntu 22.04):
```bash
sudo lxc-create -n container_name -t download -- -d ubuntu -r jammy -a amd64
```
`где: -n - имя контейнера, -t - шаблон для настройки контейнера, -d - дистрибутив, -r - релиз дистрибутива, -a - архитектура дистрибутива`
- Запуск контейнера:
```bash
sudo lxc-start -n container_name
```
- Вывести информацию о контейнере:
```bash
sudo lxc-info -n container_name
```
- Вывести информацию обо всех контейнерах:
```bash
sudo lxc-ls -f
```
`где: -f - подробный вывод`
- Подключение к оболочке контейнера:
```bash
sudo lxc-attach -n container_name
```

> Информацию о *дистрибутиве контейнера* можно увидеть если вывести в консоль содержание следующего файла: `cat /etc/os-release`.

- Остановка контейнера:
```bash
sudo lxc-stop -n container_name
```
- Удаление контейнера (контейнер должен быть остановлен):
```bash
sudo lxc-destroy -n container_name
```
- Клонирование контейнера (контейнер должен быть остановлен):
```bash
sudo lxc-copy -n container_name -N new_container_name
```
- Создание снапшота контейнера:
```bash
sudo lxc-snapshot -n container_name
```
- Просмотреть созданные снапшоты:
```bash
sudo lxc-snapshot -n container_name -L
```
- Восстановить систему из снапшота:
```bash
sudo lxc-snapshot -n container_name -r snap_name
```
- Удалить снапшот:
```bash
sudo lxc-snapshot -n container_name -d snap_name
```

[[lxc#LXC|^ В начало]]
***
## Настройки контейнеров

### Настройки автостарта

Чтобы включить *автостарт* контейнера, нужно добавить строку `lxc.start.auto = 1` в файл `/var/lib/lxc/container_name/config`.
Чтобы включить автостарт для *всех создаваемых контейнеров* по умолчанию, можно добавить данную строчку в конфиг LXC, `/etc/lxc/default.conf`.

### Настройки статического IP при помощи DHCP

- *Создаем* контейнер.
- Далее необходимо *раскомментировать* строку `LXC_DHCP_CONFILE=/etc/lxc/dnsmasq.conf` в файле `/etc/default/lxc-net`. Если адрес в строке *отличается*, можно поменять его на указанный.
- *Добавляем* запись `dhcp-host=containername,10.0.3.3` в файл `/etc/lxc/dnsmasq.conf`. Обычно диапазон `LXC_DHCP_RANGE` находится в пределах от 10.0.3.2 до 10.0.3.254.

> Если в имени контейнера содержаться знаки *нижнего подчеркивания*, например `contaner_name`, то в записи имя должно быть без них `dhcp-host=containername,10.0.3.3`. Это *критически* важно!

- *Перезапускаем* сетевой сервис lxc командой `service lxc-net restart`.
- *Проверяем* файл настроек контейнера `/var/lib/lxc/container_name/config`. В нем должны быть следующие настройки сети:
```ini
# Network configuration
lxc.net.<num>.type = veth
lxc.net.<num>.link = lxcbr0
lxc.net.<num>.flags = up
lxc.net.<num>.hwaddr = <mac_address>
```
- Если пункт с мак-адресом устройства *отсутствует*, выполняем данный шаг, иначе пропускаем. Запускаем контейнер, дожидаемся пока он получит указанный нами ip адрес, и выводим содержимое файла `/var/lib/misc/dnsmasq.lxcbr0.leases`. Находим строчку с подключением устройства к указанному нами ip адресу, второе значение в строчке, временный мак-адрес подключенного устройства. Его надо *внести* в конфиг выше. Останавливаем контейнер.
- Включаем контейнер с *постоянным* ip адресом!

> Если контейнер *восстановить* из снапшота, может поменяться MAC-адрес, соответственно нужно будет изменить его на старый. Или перед запуском контейнера удалить файл `/var/lib/misc/dnsmasq.lxcbr0.leases`, после чего перезагрузить службу `service lxc-net restart` и запустить контейнер.

### Настройки статического IP без помощи DHCP

- *Создаем и настраиваем* [[linux_network#Создание и настройка моста|мост]].
- *Создаем* контейнер.
- *Проверяем* файл настроек контейнера `/var/lib/lxc/container_name/config`. В нем должны быть следующие настройки сети:
```ini
# Network configuration
lxc.net.<num>.type = veth
lxc.net.<num>.link = <bridge_name>
lxc.net.<num>.flags = up
lxc.net.<num>.ipv4.address = 192.168.1.10/24
lxc.net.<num>.ipv4.gateway = <bridge_ip_address>
lxc.net.<num>.hwaddr = <mac_address>    # По необходимости
```

> IP-адрес назначаемый контейнеру, должен находится в одной *подсети* с мостом.

- ~~Включаем контейнер с *постоянным* ip адресом!~~ На данный момент не работает, не хватает нескольких настроек.

[[lxc#LXC|^ В начало]]
***