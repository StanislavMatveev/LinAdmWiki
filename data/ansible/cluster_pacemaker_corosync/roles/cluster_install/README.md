# Роль cluster_install

## Описание

Данная роль устанавливает и настраивает кластер Corosync + Pacemaker.
Роль адаптивная, т.е. не нужно указывать какое количество узлов вы используете, а все настройки осуществляются через переменные.
Если нод меньше 3, то роль отключит политику кворума, и не будет настраивать ноду "наблюдатель". Если больше 2, то кворум будет работать, и последняя нода всегда будет "наблюдателем" (защищена от миграции ресурсов и служит только для достижения кворума). Поскольку нода "наблюдатель", это всегда последняя нода, то если для этих целей планируется специальной машина (прим. малой мощности), то ее нужно располагать самой последней в группе нод файла inventory.
Все созданные ресурсы, будут объединены в одну группу (default_group), чтобы избежать распределения ресурсов по разным узлам.
Поскольку роль создает ресурсы для указанных systemd сервисов, стоит учитывать, что если нужная служба отсутствует на узлах, то перемещение ресурсов будет вести себя непредсказуемо, т.к. pacemaker будет пытаться запустить ресурс которого нету, а когда у него это не выйдет перемешать ресурсы на другой узел и пытаться запустить там. Это будет продолжаться до тех пор, пока pacemaker не обойдет все узлы, и не остановит отсутствующей ресурс. Но так же следует учитывать, что если какой-то узел будет перезагружен, ресурсы перейдут на него, т.к. pacemaker посчитает узел "свежим" и попытается запустить на нем отсутствующий ресурс.

## Переменные

*Переменные в каталоге defaults данной роли:*

- packages_for_install - основные пакеты для работы кластера

*Переменные которые необходимо указать в файлах group_vars:*

- Переменная с автоматической генерацией списка имен ипользуемых узлов (данные имена также будут присвоенны узлам кластера). Необходимо заменить имя группы "nodes" на свое.
nodes_list: "{{ groups['nodes'] | map('extract', hostvars, 'inventory_hostname') }}"

- Имя которое будет присвоенно кластеру.
cluster_name: test_cluster

- Пароль от пользователя "hacluster".
hacluster_pass: test

- Список виртуальных ip адресов, которые необходимо присвоить рабочему узлу кластера
virtual_ip_list:
  - 10.0.3.110

- Список systemd сервисов, для создания ресурсов для них
services_list:
  - nginx
