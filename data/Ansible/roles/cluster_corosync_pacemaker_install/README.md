# Роль cluster_corosync_pacemaker_install

## Описание

Данная роль устанавливает и настраивает кластер Corosync + Pacemaker.
Роль адаптивная, т.е. не нужно указывать какое количество узлов вы используете, а все настройки осуществляются через переменные.
Если нод меньше 3, то роль отключит политику кворума, и не будет настраивать ноду "наблюдатель". Если больше 2, то кворум будет работать, и последняя нода всегда будет "наблюдателем" (защищена от миграции ресурсов и служит только для достижения кворума). Поскольку нода "наблюдатель", это всегда последняя нода, то если для этих целей планируется специальной машина (прим. малой мощности), то ее нужно располагать самой последней в группе нод файла inventory.
Все созданные ресурсы, будут объединены в одну группу default_group, чтобы избежать распределения ресурсов по разным узлам.
Поскольку роль создает ресурсы для указанных systemd сервисов, стоит учитывать, что если нужная служба отсутствует на узлах, то перемещение ресурсов будет вести себя непредсказуемо, т.к. pacemaker будет пытаться запустить ресурс которого нету, а когда у него это не выйдет будет перемешать ресурсы на другой узел и пытаться запустить там. Это будет продолжаться до тех пор, пока pacemaker не обойдет все узлы, и не остановит отсутствующей ресурс. Но так же следует учитывать, что если какой-то узел будет перезагружен, ресурсы перейдут на него, т.к. pacemaker посчитает узел "свежим" и попытается запустить на нем отсутствующий ресурс.
Так же, роль создает маршруты для первого виртуального ip адреса, на случай если на узле используется ограничение статического ip адреса.

## Переменные

*Переменные в каталоге defaults данной роли:*

- `packages_for_install` - основные пакеты для работы кластера.

*Переменные которые необходимо указать в файлах group_vars:*

- `nodes_list` - переменная с автоматической генерацией списка имен ипользуемых узлов (данные имена также будут присвоенны узлам кластера). Необходимо заменить имя группы "nodes" на свое.
```
nodes_list: "{{ groups['nodes'] | map('extract', hostvars, 'inventory_hostname') }}"
```

- `cluster_name` - имя которое будет присвоенно кластеру.
```
cluster_name: test_cluster
```

- `hacluster_pass` - пароль от пользователя "hacluster".
```
hacluster_pass: test
```

- `virtual_ip_dict` - словарь виртуальных ip адресов, которые необходимо присвоить рабочему узлу кластера (Важно!!! Для корректной работы роли, словарь необходимо оформить в соответствии с образцом ниже).
```
virtual_ip_dict:
  1: 10.0.3.110
  2: 10.0.3.120
```

- `services_list` - список systemd сервисов, для создания ресурсов для них.
```
services_list:
  - nginx
```

