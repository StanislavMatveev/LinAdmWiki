# Роль cluster_corosync_pacemaker_install

## Описание

Данная роль устанавливает и настраивает кластер Corosync + Pacemaker.
Роль адаптивная, т.е. не нужно указывать какое количество узлов вы используете, а все настройки осуществляются через переменные.
Если нод меньше 3, то роль отключит политику кворума, и не будет настраивать ноду "наблюдатель". Если больше 2, то кворум будет работать, и последняя нода всегда будет "наблюдателем" (защищена от миграции ресурсов и служит только для достижения кворума). Поскольку нода "наблюдатель", это всегда последняя нода, то если для этих целей планируется специальной машина (прим. малой мощности), то ее нужно располагать самой последней в группе нод файла inventory.
Все созданные ресурсы, должны быть объединены в группы (прописывается в переменной), чтобы избежать распределения ресурсов по разным узлам.
Поскольку роль создает ресурсы для указанных systemd сервисов, стоит учитывать, что если нужная служба отсутствует на узлах, то перемещение ресурсов будет вести себя непредсказуемо, т.к. pacemaker будет пытаться запустить ресурс которого нету, а когда у него это не выйдет будет перемешать ресурсы на другой узел и пытаться запустить там. Это будет продолжаться до тех пор, пока pacemaker не обойдет все узлы, и не остановит отсутствующей ресурс. Но так же следует учитывать, что если какой-то узел будет перезагружен, ресурсы перейдут на него, т.к. pacemaker посчитает узел "свежим" и попытается запустить на нем отсутствующий ресурс.
На данный момент роль поддерживает создание 3-х видов ресурсов (IPaddr2, IPsrcaddr, systemd). Их необходимо указать в переменной в правильном порядке (читай ниже).

При работе с ролью, можно отключить удаление и установку пакетов, путем указания при запуске плэйбука параметра `--skip-tags packages_replace`.

## Подготовка нод

Требования к нодам:

- На нодах должен быть установлен дистрибутив семейства Debian.

- Порты 5405(udp) и 2224(tcp) должны быть свободны и доступны как изнутри, так и извне.

- Если используется ресурс IPsrcaddr, на нодах должен быть настроен статический IP-адрес, т.к. при использовании DHCP через некоторое время "отваливается" виртуальный IP-адрес, а так же при перезапуске служба corosync не может запустится с первого раза.

- Если используется ресурс IPsrcaddr, формат дефолтного маршрута должен быть вида: `default via 192.168.1.100 dev ens1 src 192.168.1.100`, т.е. в конце не должно быть опции `onlink`, которая проставляется автоматически, при использовании статического IP-адреса. Иначе ресурс IPsrcaddr не сможет распарсить информацию о текущем адресе, и ресурс завершится с ошибкой. Чтобы маршрут отображался в верном формате, можно использовать следующее решение: отредактировать файл `/etc/network/interfaces/` и вставить в блок интерфейса, на котором настроен статический IP-адрес, строчку вида:
```
iface ens1 inet static
	address 192.168.1.100
	netmask 255.255.255.0
	gateway 192.168.1.1
	post-up ip route change default via 192.168.1.1 dev ens1 src 192.168.1.100
```

## Переменные

*Переменные в каталоге defaults данной роли:*

- `packages_for_install` - основные пакеты для работы кластера (по умолчанию ставится последняя версия пакетов). Если нужна конкретная версия пакетов, то необходимо переопределить переменную в `group_vars` с указанием версии.
```
packages_for_install:
  - pacemaker=2.1.2-1ubuntu3.1
  - corosync=3.1.6-1ubuntu1
  - pcs=0.10.11-2ubuntu3
  - resource-agents=1:4.7.0-1ubuntu7.3
```

*Переменные которые необходимо указать в файлах group_vars:*

- `nodes_list` - переменная с автоматической генерацией списка имен ипользуемых узлов (данные имена также будут присвоенны узлам кластера). Необходимо заменить имя группы "nodes" на свое.
```
nodes_list: "{{ groups['nodes'] | map('extract', hostvars, 'inventory_hostname') }}"
```

- `cluster_name` - имя которое будет присвоенно кластеру.
```
cluster_name: test_cluster
```

- `hacluster_pass` - пароль от пользователя "hacluster".
```
hacluster_pass: test
```

- `resource_dict` - словарь с ресурсами, которые необходимо запустить в кластере.
Важно!!! Для корректной работы, словарь необходимо оформить в соответствии с примером, а так же придерживаться правил приведенных ниже.
```
resource_dict:
  <resource_name>:
    type: IPaddr2
    ip_addr: <virt_ip_addr>
    netmask: <virt_ip_netask>
    group: <resource_group>
  <resource_name>:
    type: IPsrcaddr
    ip_addr: <virt_ip_addr>
    netmask: <virt_ip_netmask>
    group: <resource_group>
  <resource_name>:
    type: systemd
    service_name: <systemd_service_name>
    group: <resource_group>
```

*Правила оформления переменной resource_dict:*

В данный момент, поддерживается 3 вида ресурсов:

- `IPaddr2` - ресурс для создания виртуального IP-адреса. Можно создать несколько ресурсов данного типа. Ресурсы данного типа, должны находится выше всех в словаре. В качестве параметров необходимо передать IP-адрес, сетевую маску и группу для ресурса.

- `IPsrcaddr` - ресурс который устанавливает виртуальный IP-адрес, в качестве основного адреса для хоста. В класстере может быть только один ресурс данного типа. В словаре, обязательно должен идти сразу за ресурсами типа IPaddr2. Для работы данного ресурса, необходим хотя бы один ресурс типа IPaddr2. В качестве параметров необходимо передать информацию об одном из созданный виратульных адресов, а именно его IP-адрес, сетевую маску и группу соответствующую группе виртуального адреса.

- `systemd` - ресурс для управления юнитом systemd. Можно создать несколько ресурсов данного типа. Ресурсы данного типа, должны перечисляться в словаре в самую последнюю очередь. Для работы необходимо передать имя сервиса и группу для ресурса.

> Так же, каждому юниту в начале необходимо указать его тип.

